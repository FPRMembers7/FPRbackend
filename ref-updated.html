<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Firearm Inventory Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#fff7ed',
              100: '#ffedd5',
              200: '#fed7aa',
              300: '#fdba74',
              400: '#fb923c',
              500: '#f97316',
              600: '#d2691f',
              700: '#c2410c',
              800: '#9a3412',
              900: '#7c2d12',
            },
            secondary:{
                 50: '#fff7ed'
            }
          }
        }
      }
    }
  </script>
  <style>
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .shimmer {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    .modal {
      backdrop-filter: blur(4px);
    }
    .cart-badge {
      animation: bounce 0.5s ease-in-out;
    }
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">
  <header class="bg-primary-600 text-white shadow-md">
    <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <i class="fas fa-shield-alt text-2xl"></i>
        <h1 class="text-2xl font-bold">Firearm Inventory</h1>
      </div>
      <div class="flex items-center space-x-4">
        <div class="relative">
          <input type="text" id="search-input" placeholder="Search inventory..." 
            class="py-1 px-3 pr-8 rounded text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-primary-500">
          <i class="fas fa-search absolute right-2 top-2 text-gray-500"></i>
        </div>
        <button id="refresh-btn" class="p-2 rounded hover:bg-primary-700 transition-colors">
          <i class="fas fa-sync-alt"></i>
        </button>
        <!-- Cart Button -->
        <button id="cart-btn" class="relative p-2 rounded hover:bg-primary-700 transition-colors">
          <i class="fas fa-shopping-cart text-xl"></i>
          <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
        </button>
        <!-- Orders Button -->
        <button id="orders-btn" class="p-2 rounded hover:bg-primary-700 transition-colors">
          <i class="fas fa-receipt text-xl"></i>
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
    <!-- Status Bar -->
    <div id="status-bar" class="mb-6 p-4 rounded-lg bg-white shadow-sm hidden">
      <div class="flex items-center">
        <div id="status-icon" class="mr-3 text-xl"></div>
        <div id="status-message" class="text-sm"></div>
      </div>
    </div>

    <!-- Filters -->
    <div class="mb-6 bg-white p-4 rounded-lg shadow-sm">
      <div class="flex flex-wrap items-center gap-4">
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
          <select id="sort-select" class="w-full rounded border-gray-300 py-2 px-3 text-sm focus:ring-primary-500 focus:border-primary-500">
            <option value="name">Name (A-Z)</option>
            <option value="price-low">Price (Low to High)</option>
            <option value="price-high">Price (High to Low)</option>
            <option value="qty-low">Quantity (Low to High)</option>
            <option value="qty-high">Quantity (High to Low)</option>
          </select>
        </div>
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-700 mb-1">Filter By Quantity</label>
          <select id="qty-filter" class="w-full rounded border-gray-300 py-2 px-3 text-sm focus:ring-primary-500 focus:border-primary-500">
            <option value="all">All Items</option>
            <option value="in-stock">In Stock</option>
            <option value="low-stock">Low Stock (< 5)</option>
            <option value="out-of-stock">Out of Stock</option>
          </select>
        </div>
        <div class="flex items-end">
          <button id="apply-filters" class="bg-primary-600 hover:bg-primary-700 text-white py-2 px-4 rounded text-sm transition-colors">
            Apply Filters
          </button>
        </div>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-primary-500">
        <div class="text-sm text-gray-500 mb-1">Total Items</div>
        <div id="total-items" class="text-2xl font-bold">--</div>
      </div>
      <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-green-500">
        <div class="text-sm text-gray-500 mb-1">In Stock</div>
        <div id="in-stock" class="text-2xl font-bold">--</div>
      </div>
      <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-yellow-500">
        <div class="text-sm text-gray-500 mb-1">Low Stock</div>
        <div id="low-stock" class="text-2xl font-bold">--</div>
      </div>
      <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-red-500">
        <div class="text-sm text-gray-500 mb-1">Out of Stock</div>
        <div id="out-of-stock" class="text-2xl font-bold">--</div>
      </div>
    </div>

    <!-- Skeleton Loader -->
    <div id="skeleton" class="bg-white rounded-lg shadow-sm overflow-hidden mb-6">
      <div class="overflow-x-auto">
        <table class="min-w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item #</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">UPC</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody id="skeleton-body" class="bg-white divide-y divide-gray-200">
            <!-- Skeleton rows will be inserted here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Inventory Table -->
    <div id="inventory-table" class="bg-white rounded-lg shadow-sm overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item #</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">UPC</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody id="table-body" class="bg-white divide-y divide-gray-200">
            <!-- Table rows will be inserted here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden text-center py-12 bg-white rounded-lg shadow-sm">
      <div class="text-gray-400 text-6xl mb-4">
        <i class="fas fa-box-open"></i>
      </div>
      <h3 class="text-xl font-medium text-gray-700 mb-2">No items found</h3>
      <p class="text-gray-500 mb-4">Try adjusting your search or filter criteria</p>
      <button id="reset-filters" class="px-4 py-2 bg-primary-600 text-white rounded hover:bg-primary-700">
        Reset Filters
      </button>
    </div>

    <!-- Load More -->
    <div class="text-center mt-8">
      <button id="load-more" class="px-6 py-2 bg-primary-600 text-white rounded hover:bg-primary-700 transition-colors">
        Load More
      </button>
    </div>
  </main>

  <!-- Item Details Modal -->
  <div id="item-modal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold text-gray-900">Item Details</h2>
          <button id="close-modal" class="text-gray-400 hover:text-gray-600 text-2xl">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div id="modal-content" class="space-y-4">
          <!-- Modal content will be inserted here -->
        </div>
        
        <div class="flex gap-3 mt-6 pt-4 border-t">
          <button id="modal-add-to-cart" class="flex-1 bg-primary-600 hover:bg-primary-700 text-white py-2 px-4 rounded transition-colors">
            <i class="fas fa-shopping-cart mr-2"></i>
            Add to Cart
          </button>
          <button id="close-modal-btn" class="px-6 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Cart Modal -->
  <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold text-gray-900">Shopping Cart</h2>
          <button id="close-cart-modal" class="text-gray-400 hover:text-gray-600 text-2xl">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div id="cart-content" class="space-y-4">
          <!-- Cart content will be inserted here -->
        </div>
        
        <div class="flex gap-3 mt-6 pt-4 border-t">
          <button id="checkout-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded transition-colors">
            <i class="fas fa-credit-card mr-2"></i>
            Checkout
          </button>
          <button id="clear-cart-btn" class="px-6 py-2 border border-red-300 text-red-700 rounded hover:bg-red-50 transition-colors">
            Clear Cart
          </button>
          <button id="close-cart-btn" class="px-6 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Orders Modal -->
  <div id="orders-modal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-6xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold text-gray-900">Order History</h2>
          <button id="close-orders-modal" class="text-gray-400 hover:text-gray-600 text-2xl">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div id="orders-content" class="space-y-4">
          <!-- Orders content will be inserted here -->
        </div>
        
        <div class="flex gap-3 mt-6 pt-4 border-t">
          <button id="refresh-orders-btn" class="bg-primary-600 hover:bg-primary-700 text-white py-2 px-4 rounded transition-colors">
            <i class="fas fa-sync-alt mr-2"></i>
            Refresh Orders
          </button>
          <button id="close-orders-btn" class="px-6 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div id="checkout-modal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold text-gray-900">Checkout</h2>
          <button id="close-checkout-modal" class="text-gray-400 hover:text-gray-600 text-2xl">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <form id="checkout-form" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">PO Number</label>
              <input type="text" id="po-number" required class="w-full rounded border-gray-300 py-2 px-3 text-sm focus:ring-primary-500 focus:border-primary-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Shipping Method</label>
              <select id="shipping-method" required class="w-full rounded border-gray-300 py-2 px-3 text-sm focus:ring-primary-500 focus:border-primary-500">
                <option value="">Select Shipping</option>
                <option value="GROUND">Ground</option>
                <option value="2DAY">2-Day Air</option>
                <option value="NEXTDAY">Next Day</option>
                <option value="NEXTSAVER">Next Day Saver</option>
              </select>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Ship To Name</label>
              <input type="text" id="ship-name" required class="w-full rounded border-gray-300 py-2 px-3 text-sm focus:ring-primary-500 focus:border-primary-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Ship To Company</label>
              <input type="text" id="ship-company" class="w-full rounded border-gray-300 py-2 px-3 text-sm focus:ring-primary-500 focus:border-primary-500">
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Ship To Address</label>
            <input type="text" id="ship-address" required class="w-full rounded border-gray-300 py-2 px-3 text-sm focus:ring-primary-500 focus:border-primary-500">
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">City</label>
              <input type="text" id="ship-city" required class="w-full rounded border-gray-300 py-2 px-3 text-sm focus:ring-primary-500 focus:border-primary-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
              <input type="text" id="ship-state" required maxlength="2" class="w-full rounded border-gray-300 py-2 px-3 text-sm focus:ring-primary-500 focus:border-primary-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ZIP Code</label>
              <input type="text" id="ship-zip" required class="w-full rounded border-gray-300 py-2 px-3 text-sm focus:ring-primary-500 focus:border-primary-500">
            </div>
          </div>
          
          <div class="flex gap-3 mt-6 pt-4 border-t">
            <button type="submit" id="place-order-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded transition-colors">
              <i class="fas fa-check mr-2"></i>
              Place Order
            </button>
            <button type="button" id="cancel-checkout-btn" class="px-6 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Cart Success Toast -->
  <div id="cart-toast" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50">
    <div class="flex items-center">
      <i class="fas fa-check-circle mr-2"></i>
      <span>Item added to cart!</span>
    </div>
  </div>

  <!-- Order Success Toast -->
  <div id="order-toast" class="fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50">
    <div class="flex items-center">
      <i class="fas fa-check-circle mr-2"></i>
      <span id="order-toast-message">Order placed successfully!</span>
    </div>
  </div>

  <script>
    const API_ENDPOINT = "https://fprbackend.netlify.app/.netlify/functions/dailyItemUpdate";
    const ORDER_API_ENDPOINT = "https://fprbackend.netlify.app/.netlify/functions/orderManagement";
    
    const tableBody = document.getElementById('table-body');
    const skeletonBody = document.getElementById('skeleton-body');
    const skeleton = document.getElementById('skeleton');
    const inventoryTable = document.getElementById('inventory-table');
    const loadMoreBtn = document.getElementById('load-more');
    const searchInput = document.getElementById('search-input');
    const sortSelect = document.getElementById('sort-select');
    const qtyFilter = document.getElementById('qty-filter');
    const applyFiltersBtn = document.getElementById('apply-filters');
    const resetFiltersBtn = document.getElementById('reset-filters');
    const refreshBtn = document.getElementById('refresh-btn');
    const emptyState = document.getElementById('empty-state');
    const statusBar = document.getElementById('status-bar');
    const statusIcon = document.getElementById('status-icon');
    const statusMessage = document.getElementById('status-message');
    
    // Modal elements
    const itemModal = document.getElementById('item-modal');
    const closeModal = document.getElementById('close-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const modalContent = document.getElementById('modal-content');
    const modalAddToCart = document.getElementById('modal-add-to-cart');
    const cartToast = document.getElementById('cart-toast');
    const orderToast = document.getElementById('order-toast');
    const orderToastMessage = document.getElementById('order-toast-message');
    
    // Cart elements
    const cartBtn = document.getElementById('cart-btn');
    const cartCount = document.getElementById('cart-count');
    const cartModal = document.getElementById('cart-modal');
    const closeCartModal = document.getElementById('close-cart-modal');
    const closeCartBtn = document.getElementById('close-cart-btn');
    const cartContent = document.getElementById('cart-content');
    const checkoutBtn = document.getElementById('checkout-btn');
    const clearCartBtn = document.getElementById('clear-cart-btn');
    
    // Orders elements
    const ordersBtn = document.getElementById('orders-btn');
    const ordersModal = document.getElementById('orders-modal');
    const closeOrdersModal = document.getElementById('close-orders-modal');
    const closeOrdersBtn = document.getElementById('close-orders-btn');
    const ordersContent = document.getElementById('orders-content');
    const refreshOrdersBtn = document.getElementById('refresh-orders-btn');
    
    // Checkout elements
    const checkoutModal = document.getElementById('checkout-modal');
    const closeCheckoutModal = document.getElementById('close-checkout-modal');
    const checkoutForm = document.getElementById('checkout-form');
    const cancelCheckoutBtn = document.getElementById('cancel-checkout-btn');
    const placeOrderBtn = document.getElementById('place-order-btn');
    
    // Stats elements
    const totalItemsEl = document.getElementById('total-items');
    const inStockEl = document.getElementById('in-stock');
    const lowStockEl = document.getElementById('low-stock');
    const outOfStockEl = document.getElementById('out-of-stock');

    let allItems = [];
    let filteredItems = [];
    let visibleCount = 0;
    let searchTerm = '';
    let currentSort = 'name';
    let currentQtyFilter = 'all';
    let currentModalItem = null;
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    let orders = JSON.parse(localStorage.getItem('orders') || '[]');

    // Cart functionality
    function updateCartCount() {
      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
      cartCount.textContent = totalItems;
      cartCount.classList.toggle('hidden', totalItems === 0);
      if (totalItems > 0) {
        cartCount.classList.add('cart-badge');
        setTimeout(() => cartCount.classList.remove('cart-badge'), 500);
      }
    }

    function addToCart(item, quantity = 1) {
      const existingItem = cart.find(cartItem => cartItem.ITEMNO === item.ITEMNO);
      
      if (existingItem) {
        existingItem.quantity += quantity;
      } else {
        cart.push({
          ...item,
          quantity: quantity
        });
      }
      
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCartCount();
      
      // Show success toast
      cartToast.style.transform = 'translateX(0)';
      setTimeout(() => {
        cartToast.style.transform = 'translateX(100%)';
      }, 3000);
    }

    function removeFromCart(itemNo) {
      cart = cart.filter(item => item.ITEMNO !== itemNo);
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCartCount();
      renderCart();
    }

    function updateCartQuantity(itemNo, quantity) {
      const item = cart.find(cartItem => cartItem.ITEMNO === itemNo);
      if (item) {
        if (quantity <= 0) {
          removeFromCart(itemNo);
        } else {
          item.quantity = quantity;
          localStorage.setItem('cart', JSON.stringify(cart));
          updateCartCount();
          renderCart();
        }
      }
    }

    function clearCart() {
      cart = [];
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCartCount();
      renderCart();
    }

    function renderCart() {
      if (cart.length === 0) {
        cartContent.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-shopping-cart text-4xl text-gray-400 mb-4"></i>
            <p class="text-gray-500">Your cart is empty</p>
          </div>
        `;
        return;
      }

      const total = cart.reduce((sum, item) => sum + (parseFloat(item.PRC1 || 0) * item.quantity), 0);
      
      cartContent.innerHTML = `
        <div class="space-y-4">
          ${cart.map(item => `
            <div class="flex items-center justify-between p-4 border rounded-lg">
              <div class="flex-1">
                <h4 class="font-medium">${item.IDESC}</h4>
                <p class="text-sm text-gray-500">Item #: ${item.ITEMNO}</p>
                <p class="text-lg font-semibold text-primary-600">$${parseFloat(item.PRC1 || 0).toFixed(2)}</p>
              </div>
              <div class="flex items-center space-x-2">
                <button onclick="updateCartQuantity('${item.ITEMNO}', ${item.quantity - 1})" 
                  class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center">
                  <i class="fas fa-minus text-xs"></i>
                </button>
                <span class="w-12 text-center">${item.quantity}</span>
                <button onclick="updateCartQuantity('${item.ITEMNO}', ${item.quantity + 1})" 
                  class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center">
                  <i class="fas fa-plus text-xs"></i>
                </button>
                <button onclick="removeFromCart('${item.ITEMNO}')" 
                  class="ml-4 text-red-500 hover:text-red-700">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          `).join('')}
        </div>
        <div class="mt-6 pt-4 border-t">
          <div class="flex justify-between items-center text-xl font-bold">
            <span>Total: $${total.toFixed(2)}</span>
          </div>
        </div>
      `;
    }

    // Order functionality
    async function placeOrder(orderData) {
      try {
        showStatus('loading', 'Placing order...');
        
        const response = await fetch(ORDER_API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'placeOrder',
            orderData: orderData,
            items: cart
          })
        });

        const result = await response.json();
        
        if (result.success) {
          // Add order to local storage
          const newOrder = {
            orderNumber: result.orderNumber,
            poNumber: orderData.poNumber,
            date: new Date().toISOString(),
            items: [...cart],
            total: cart.reduce((sum, item) => sum + (parseFloat(item.PRC1 || 0) * item.quantity), 0),
            status: 'Submitted',
            shipping: orderData
          };
          
          orders.unshift(newOrder);
          localStorage.setItem('orders', JSON.stringify(orders));
          
          // Clear cart
          clearCart();
          
          // Close modals
          closeCheckoutModalFunc();
          closeCartModalFunc();
          
          // Show success message
          orderToastMessage.textContent = `Order #${result.orderNumber} placed successfully!`;
          orderToast.style.transform = 'translateX(0)';
          setTimeout(() => {
            orderToast.style.transform = 'translateX(100%)';
          }, 5000);
          
          showStatus('success', `Order #${result.orderNumber} placed successfully!`);
        } else {
          throw new Error(result.message || 'Failed to place order');
        }
      } catch (error) {
        showStatus('error', `Failed to place order: ${error.message}`);
        console.error('Order placement error:', error);
      }
    }

    async function loadOrders() {
      try {
        showStatus('loading', 'Loading orders...');
        
        const response = await fetch(ORDER_API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'getOrders'
          })
        });

        const result = await response.json();
        
        if (result.success && result.orders) {
          // Merge with local orders
          const remoteOrders = result.orders;
          const mergedOrders = [...orders];
          
          remoteOrders.forEach(remoteOrder => {
            const existingIndex = mergedOrders.findIndex(order => order.orderNumber === remoteOrder.orderNumber);
            if (existingIndex >= 0) {
              mergedOrders[existingIndex] = { ...mergedOrders[existingIndex], ...remoteOrder };
            } else {
              mergedOrders.push(remoteOrder);
            }
          });
          
          orders = mergedOrders.sort((a, b) => new Date(b.date) - new Date(a.date));
          localStorage.setItem('orders', JSON.stringify(orders));
          
          showStatus('success', `Loaded ${orders.length} orders`);
        }
        
        renderOrders();
      } catch (error) {
        showStatus('error', `Failed to load orders: ${error.message}`);
        renderOrders(); // Still show local orders
      }
    }

    function renderOrders() {
      if (orders.length === 0) {
        ordersContent.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-receipt text-4xl text-gray-400 mb-4"></i>
            <p class="text-gray-500">No orders found</p>
          </div>
        `;
        return;
      }

      ordersContent.innerHTML = `
        <div class="space-y-4">
          ${orders.map(order => `
            <div class="border rounded-lg p-4">
              <div class="flex justify-between items-start mb-3">
                <div>
                  <h4 class="font-semibold">Order #${order.orderNumber}</h4>
                  <p class="text-sm text-gray-500">PO: ${order.poNumber}</p>
                  <p class="text-sm text-gray-500">Date: ${new Date(order.date).toLocaleDateString()}</p>
                </div>
                <div class="text-right">
                  <p class="font-semibold">$${order.total.toFixed(2)}</p>
                  <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                    order.status === 'Submitted' ? 'bg-green-100 text-green-800' :
                    order.status === 'Processing' ? 'bg-yellow-100 text-yellow-800' :
                    'bg-gray-100 text-gray-800'
                  }">
                    ${order.status}
                  </span>
                </div>
              </div>
              <div class="text-sm text-gray-600">
                <p>${order.items.length} item(s)</p>
                ${order.trackingNumber ? `<p>Tracking: ${order.trackingNumber}</p>` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Modal functionality
    function openModal(item) {
      currentModalItem = item;
      
      const qty = parseInt(item.QTYOH) || 0;
      let stockStatus = '';
      let stockClass = '';
      
      if (qty <= 0) {
        stockStatus = 'Out of Stock';
        stockClass = 'bg-red-100 text-red-800';
      } else if (qty < 5) {
        stockStatus = 'Low Stock';
        stockClass = 'bg-yellow-100 text-yellow-800';
      } else {
        stockStatus = 'In Stock';
        stockClass = 'bg-green-100 text-green-800';
      }
      
      modalContent.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h3 class="text-lg font-semibold mb-3">Product Information</h3>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-500">Item Number</label>
                <p class="text-lg">${item.ITEMNO}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-500">Description</label>
                <p class="text-lg">${item.IDESC}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-500">UPC Code</label>
                <p class="text-lg">${item.ITUPC || 'N/A'}</p>
              </div>
            </div>
          </div>
          <div>
            <h3 class="text-lg font-semibold mb-3">Pricing & Availability</h3>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-500">Price</label>
                <p class="text-2xl font-bold text-primary-600">$${parseFloat(item.PRC1 || 0).toFixed(2)}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-500">Quantity Available</label>
                <p class="text-lg">${item.QTYOH || 0} units</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-500">Status</label>
                <span class="inline-flex px-3 py-1 text-sm font-medium rounded-full ${stockClass}">
                  ${stockStatus}
                </span>
              </div>
            </div>
          </div>
        </div>
      `;
      
      itemModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeModalFunc() {
      itemModal.classList.add('hidden');
      document.body.style.overflow = 'auto';
      currentModalItem = null;
    }

    function openCartModal() {
      renderCart();
      cartModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeCartModalFunc() {
      cartModal.classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    function openOrdersModal() {
      loadOrders();
      ordersModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeOrdersModalFunc() {
      ordersModal.classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    function openCheckoutModal() {
      if (cart.length === 0) {
        showStatus('warning', 'Your cart is empty');
        return;
      }
      closeCartModalFunc();
      checkoutModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeCheckoutModalFunc() {
      checkoutModal.classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    // Event listeners for modals
    closeModal.addEventListener('click', closeModalFunc);
    closeModalBtn.addEventListener('click', closeModalFunc);
    modalAddToCart.addEventListener('click', () => {
      if (currentModalItem) {
        addToCart(currentModalItem);
        closeModalFunc();
      }
    });

    cartBtn.addEventListener('click', openCartModal);
    closeCartModal.addEventListener('click', closeCartModalFunc);
    closeCartBtn.addEventListener('click', closeCartModalFunc);
    checkoutBtn.addEventListener('click', openCheckoutModal);
    clearCartBtn.addEventListener('click', () => {
      if (confirm('Are you sure you want to clear your cart?')) {
        clearCart();
      }
    });

    ordersBtn.addEventListener('click', openOrdersModal);
    closeOrdersModal.addEventListener('click', closeOrdersModalFunc);
    closeOrdersBtn.addEventListener('click', closeOrdersModalFunc);
    refreshOrdersBtn.addEventListener('click', loadOrders);

    closeCheckoutModal.addEventListener('click', closeCheckoutModalFunc);
    cancelCheckoutBtn.addEventListener('click', closeCheckoutModalFunc);

    checkoutForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const orderData = {
        poNumber: document.getElementById('po-number').value,
        shippingMethod: document.getElementById('shipping-method').value,
        shipName: document.getElementById('ship-name').value,
        shipCompany: document.getElementById('ship-company').value,
        shipAddress: document.getElementById('ship-address').value,
        shipCity: document.getElementById('ship-city').value,
        shipState: document.getElementById('ship-state').value,
        shipZip: document.getElementById('ship-zip').value
      };
      
      placeOrder(orderData);
    });

    // Close modals when clicking outside
    [itemModal, cartModal, ordersModal, checkoutModal].forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = 'auto';
        }
      });
    });

    // Close modals with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        [itemModal, cartModal, ordersModal, checkoutModal].forEach(modal => {
          if (!modal.classList.contains('hidden')) {
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
          }
        });
      }
    });

    // Show status message
    function showStatus(type, message) {
      statusBar.className = 'mb-6 p-4 rounded-lg shadow-sm flex items-center';
      statusMessage.textContent = message;
      
      switch(type) {
        case 'loading':
          statusBar.classList.add('bg-blue-50', 'border', 'border-blue-200');
          statusIcon.className = 'mr-3 text-xl text-blue-500 fas fa-circle-notch fa-spin';
          break;
        case 'success':
          statusBar.classList.add('bg-green-50', 'border', 'border-green-200');
          statusIcon.className = 'mr-3 text-xl text-green-500 fas fa-check-circle';
          break;
        case 'error':
          statusBar.classList.add('bg-red-50', 'border', 'border-red-200');
          statusIcon.className = 'mr-3 text-xl text-red-500 fas fa-exclamation-circle';
          break;
        case 'warning':
          statusBar.classList.add('bg-yellow-50', 'border', 'border-yellow-200');
          statusIcon.className = 'mr-3 text-xl text-yellow-500 fas fa-exclamation-triangle';
          break;
      }
      
      statusBar.classList.remove('hidden');
      
      if (type !== 'loading') {
        setTimeout(() => {
          statusBar.classList.add('hidden');
        }, 5000);
      }
    }

    // Add skeleton rows
    function showSkeleton(count = 10) {
      skeletonBody.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="px-6 py-4"><div class="h-4 shimmer rounded w-20"></div></td>
          <td class="px-6 py-4"><div class="h-4 shimmer rounded w-48"></div></td>
          <td class="px-6 py-4"><div class="h-4 shimmer rounded w-24"></div></td>
          <td class="px-6 py-4"><div class="h-4 shimmer rounded w-16"></div></td>
          <td class="px-6 py-4"><div class="h-4 shimmer rounded w-12"></div></td>
          <td class="px-6 py-4"><div class="h-6 shimmer rounded w-20"></div></td>
          <td class="px-6 py-4"><div class="h-8 shimmer rounded w-32"></div></td>
        `;
        skeletonBody.appendChild(row);
      }
      skeleton.classList.remove('hidden');
      inventoryTable.classList.add('hidden');
    }

    function hideSkeleton() {
      skeleton.classList.add('hidden');
      inventoryTable.classList.remove('hidden');
    }

    // Create table row
    function createTableRow(item) {
      const row = document.createElement('tr');
      row.className = 'hover:bg-gray-50 fade-in';
      
      // Determine stock status
      let stockStatus = '';
      let stockClass = '';
      const qty = parseInt(item.QTYOH) || 0;
      
      if (qty <= 0) {
        stockStatus = 'Out of Stock';
        stockClass = 'bg-red-100 text-red-800';
      } else if (qty < 5) {
        stockStatus = 'Low Stock';
        stockClass = 'bg-yellow-100 text-yellow-800';
      } else {
        stockStatus = 'In Stock';
        stockClass = 'bg-green-100 text-green-800';
      }
      
      row.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.ITEMNO}</td>
        <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate" title="${item.IDESC}">${item.IDESC}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.ITUPC || 'N/A'}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-primary-600">$${parseFloat(item.PRC1 || 0).toFixed(2)}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.QTYOH || 0}</td>
        <td class="px-6 py-4 whitespace-nowrap">
          <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${stockClass}">
            ${stockStatus}
          </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
          <div class="flex space-x-2">
            <button class="view-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs transition-colors">
              <i class="fas fa-eye mr-1"></i>View
            </button>
            <button class="cart-btn bg-primary-600 hover:bg-primary-700 text-white px-3 py-1 rounded text-xs transition-colors ${qty <= 0 ? 'opacity-50 cursor-not-allowed' : ''}">
              <i class="fas fa-shopping-cart mr-1"></i>Add to Cart
            </button>
          </div>
        </td>
      `;
      
      // Add event listeners to buttons
      const viewBtn = row.querySelector('.view-btn');
      const cartBtn = row.querySelector('.cart-btn');
      
      viewBtn.addEventListener('click', () => openModal(item));
      
      if (qty > 0) {
        cartBtn.addEventListener('click', () => addToCart(item));
      }
      
      return row;
    }

    // Update stats
    function updateStats() {
      if (allItems.length === 0) return;
      
      const total = allItems.length;
      const inStock = allItems.filter(item => parseInt(item.QTYOH) > 0).length;
      const lowStock = allItems.filter(item => parseInt(item.QTYOH) > 0 && parseInt(item.QTYOH) < 5).length;
      const outOfStock = allItems.filter(item => parseInt(item.QTYOH) <= 0).length;
      
      totalItemsEl.textContent = total;
      inStockEl.textContent = inStock;
      lowStockEl.textContent = lowStock;
      outOfStockEl.textContent = outOfStock;
    }

    // Filter and sort items
    function filterAndSortItems() {
      // Filter by search term
      let filtered = allItems;
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        filtered = filtered.filter(item => 
          (item.IDESC && item.IDESC.toLowerCase().includes(term)) || 
          (item.ITEMNO && item.ITEMNO.toLowerCase().includes(term)) || 
          (item.ITUPC && item.ITUPC.toLowerCase().includes(term))
        );
      }
      
      // Filter by quantity
      switch (currentQtyFilter) {
        case 'in-stock':
          filtered = filtered.filter(item => parseInt(item.QTYOH) > 0);
          break;
        case 'low-stock':
          filtered = filtered.filter(item => parseInt(item.QTYOH) > 0 && parseInt(item.QTYOH) < 5);
          break;
        case 'out-of-stock':
          filtered = filtered.filter(item => parseInt(item.QTYOH) <= 0);
          break;
      }
      
      // Sort items
      filtered.sort((a, b) => {
        switch (currentSort) {
          case 'name':
            return (a.IDESC || '').localeCompare(b.IDESC || '');
          case 'price-low':
            return parseFloat(a.PRC1 || 0) - parseFloat(b.PRC1 || 0);
          case 'price-high':
            return parseFloat(b.PRC1 || 0) - parseFloat(a.PRC1 || 0);
          case 'qty-low':
            return parseInt(a.QTYOH || 0) - parseInt(b.QTYOH || 0);
          case 'qty-high':
            return parseInt(b.QTYOH || 0) - parseInt(a.QTYOH || 0);
          default:
            return 0;
        }
      });
      
      return filtered;
    }

    // Render items
    function renderItems(count = 20) {
      // Clear existing items if this is a fresh render
      if (visibleCount === 0) {
        tableBody.innerHTML = '';
      }
      
      const nextItems = filteredItems.slice(visibleCount, visibleCount + count);
      nextItems.forEach(item => {
        tableBody.appendChild(createTableRow(item));
      });
      visibleCount += nextItems.length;

      // Show/hide load more button
      loadMoreBtn.style.display = visibleCount >= filteredItems.length ? 'none' : 'inline-block';
      
      // Show empty state if no items
      const hasItems = filteredItems.length > 0;
      emptyState.classList.toggle('hidden', hasItems);
      inventoryTable.classList.toggle('hidden', !hasItems);
    }

    // Apply filters and refresh the view
    function applyFilters() {
      visibleCount = 0;
      filteredItems = filterAndSortItems();
      renderItems();
    }

    // Extract data from SOAP XML response
    function extractDataFromSoapXml(xmlString) {
      try {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlString, "text/xml");
        
        const parserError = xmlDoc.querySelector('parsererror');
        if (parserError) {
          console.error('XML parsing error:', parserError.textContent);
          return [];
        }
        
        let dataContent = '';
        const updateResult = xmlDoc.querySelector('DailyItemUpdateResult');
        if (updateResult) {
          dataContent = updateResult.textContent || updateResult.innerHTML;
        }
        
        if (!dataContent) {
          console.error('Could not find data content in SOAP response');
          return [];
        }
        
        let innerXmlDoc;
        try {
          innerXmlDoc = parser.parseFromString(dataContent, "text/xml");
        } catch (e) {
          const unescapedContent = dataContent
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&amp;/g, '&')
            .replace(/&quot;/g, '"')
            .replace(/&#39;/g, "'");
          
          innerXmlDoc = parser.parseFromString(unescapedContent, "text/xml");
        }
        
        const tables = Array.from(innerXmlDoc.getElementsByTagName("Table"));
        
        if (tables.length === 0) {
          const alternativeContainers = ['NewDataSet', 'DataSet', 'diffgr:diffgram', 'diffgram'];
          for (const containerName of alternativeContainers) {
            const container = innerXmlDoc.querySelector(containerName);
            if (container) {
              const tablesInContainer = Array.from(container.getElementsByTagName("Table"));
              if (tablesInContainer.length > 0) {
                tables.push(...tablesInContainer);
                break;
              }
            }
          }
        }
        
        return tables.map(table => {
          const get = tag => {
            const element = table.getElementsByTagName(tag)[0];
            return element ? element.textContent.trim() : '';
          };
          
          return {
            ITEMNO: get("ITEMNO"),
            IDESC: get("IDESC"),
            ITUPC: get("ITUPC"),
            PRC1: get("PRC1"),
            QTYOH: get("QTYOH")
          };
        });
        
      } catch (e) {
        console.error("Error processing XML:", e);
        return [];
      }
    }

    // Fetch items from API
    async function fetchItems() {
      showStatus('loading', 'Fetching inventory data...');
      showSkeleton();
      
      try {
        const res = await fetch(API_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            lastUpdate: "1/6/2025",
            lastItem: 10,
            source: "FPR"
          }),
        });
        
        if (!res.ok) {
          throw new Error(`HTTP error! Status: ${res.status}`);
        }
        
        const json = await res.json();
        
        if (!json.success) {
          throw new Error(json.message || 'API returned an error');
        }
        
        allItems = extractDataFromSoapXml(json.xml);
        
        if (allItems.length === 0) {
          showStatus('warning', 'No inventory items found in the data');
        } else {
          updateStats();
          filteredItems = filterAndSortItems();
          showStatus('success', `Successfully loaded ${allItems.length} inventory items`);
          renderItems();
        }
        
      } catch (e) {
        showStatus('error', `Failed to load inventory: ${e.message}`);
        console.error(e);
      } finally {
        hideSkeleton();
      }
    }

    // Event Listeners
    loadMoreBtn.addEventListener('click', () => renderItems(20));
    
    applyFiltersBtn.addEventListener('click', () => {
      searchTerm = searchInput.value;
      currentSort = sortSelect.value;
      currentQtyFilter = qtyFilter.value;
      applyFilters();
    });
    
    resetFiltersBtn.addEventListener('click', () => {
      searchInput.value = '';
      sortSelect.value = 'name';
      qtyFilter.value = 'all';
      searchTerm = '';
      currentSort = 'name';
      currentQtyFilter = 'all';
      applyFilters();
    });
    
    refreshBtn.addEventListener('click', () => {
      allItems = [];
      visibleCount = 0;
      tableBody.innerHTML = '';
      fetchItems();
    });
    
    // Search on enter key
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        searchTerm = searchInput.value;
        applyFilters();
      }
    });

    // Initialize
    updateCartCount();
    fetchItems();
  </script>
</body>
</html>
