<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventory Data Viewer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background-color: #f8f9fa;
    }
    .card {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    .table-responsive {
      max-height: 600px;
      overflow-y: auto;
    }
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
    }
    .spinner-border {
      width: 3rem;
      height: 3rem;
    }
    .pagination-info {
      font-size: 0.9rem;
      color: #6c757d;
    }
    .filter-badge {
      margin-right: 5px;
      cursor: pointer;
    }
    .date-range {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    @media (max-width: 768px) {
      .date-range {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="my-4">Inventory Data Viewer</h1>
    
    <!-- Filters and Date Selection -->
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Search & Filters</h5>
        
        <div class="row g-3 mb-3">
          <!-- Date Range Selection -->
          <div class="col-md-6">
            <label class="form-label">Date Range</label>
            <div class="date-range">
              <input type="date" id="startDate" class="form-control" value="2024-01-01">
              <span>to</span>
              <input type="date" id="endDate" class="form-control" value="2024-03-31">
            </div>
          </div>
          
          <!-- Search -->
          <div class="col-md-6">
            <label for="searchInput" class="form-label">Search</label>
            <input type="text" id="searchInput" class="form-control" placeholder="Search by item number or description">
          </div>
        </div>
        
        <!-- Additional Filters -->
        <div class="row g-3">
          <div class="col-md-4">
            <label for="priceRange" class="form-label">Max Price: $<span id="priceValue">1000</span></label>
            <input type="range" class="form-range" id="priceRange" min="0" max="2000" step="10" value="1000">
          </div>
          
          <div class="col-md-4">
            <label for="itemsPerPage" class="form-label">Items Per Page</label>
            <select id="itemsPerPage" class="form-select">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>
          
          <div class="col-md-4 d-flex align-items-end">
            <button id="loadDataBtn" class="btn btn-primary w-100">
              <i class="bi bi-search"></i> Load Data
            </button>
          </div>
        </div>
        
        <!-- Active Filters -->
        <div id="activeFilters" class="mt-3">
          <!-- Active filters will be displayed here -->
        </div>
      </div>
    </div>
    
    <!-- Results Card -->
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="card-title mb-0">Inventory Results</h5>
          <div class="pagination-info">
            Showing <span id="startItem">0</span>-<span id="endItem">0</span> of <span id="totalItems">0</span> items
          </div>
        </div>
        
        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading d-none">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
        
        <!-- Table Container -->
        <div class="table-responsive">
          <table id="dataTable" class="table table-striped table-hover">
            <thead>
              <tr>
                <th>Item Number</th>
                <th>Description</th>
                <th>Price</th>
                <th>Category</th>
                <th>Stock</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <!-- Data will be loaded here -->
              <tr>
                <td colspan="5" class="text-center">No data available. Please select a date range and click "Load Data".</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <!-- Pagination -->
        <nav aria-label="Page navigation" class="mt-3">
          <ul id="pagination" class="pagination justify-content-center">
            <!-- Pagination will be generated here -->
          </ul>
        </nav>
      </div>
    </div>
  </div>

  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Global variables
    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    let itemsPerPage = 25;
    
    // DOM Elements
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const searchInput = document.getElementById('searchInput');
    const priceRangeInput = document.getElementById('priceRange');
    const priceValueSpan = document.getElementById('priceValue');
    const itemsPerPageSelect = document.getElementById('itemsPerPage');
    const loadDataBtn = document.getElementById('loadDataBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const tableBody = document.getElementById('tableBody');
    const paginationElement = document.getElementById('pagination');
    const startItemSpan = document.getElementById('startItem');
    const endItemSpan = document.getElementById('endItem');
    const totalItemsSpan = document.getElementById('totalItems');
    const activeFiltersDiv = document.getElementById('activeFilters');
    
    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
      loadDataBtn.addEventListener('click', loadData);
      searchInput.addEventListener('input', applyFilters);
      priceRangeInput.addEventListener('input', updatePriceValue);
      itemsPerPageSelect.addEventListener('change', changeItemsPerPage);
    });
    
    // Update price value display
    function updatePriceValue() {
      priceValueSpan.textContent = priceRangeInput.value;
      applyFilters();
    }
    
    // Change items per page
    function changeItemsPerPage() {
      itemsPerPage = parseInt(itemsPerPageSelect.value);
      currentPage = 1;
      renderTable();
    }
    
    // Format date for SOAP request
    function formatDateForSoap(dateString) {
      const date = new Date(dateString);
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const year = date.getFullYear();
      return `${month}/${day}/${year}`;
    }
    
    // Load data from API
    async function loadData() {
      // Show loading indicator
      loadingIndicator.classList.remove('d-none');
      tableBody.innerHTML = '';
      
      try {
        const startDate = formatDateForSoap(startDateInput.value);
        const endDate = formatDateForSoap(endDateInput.value);
        
        // Create SOAP request for the selected date range
        const soapBody = `<?xml version="1.0" encoding="utf-8"?>
          <soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                         xmlns:xsd="http://www.w3.org/2001/XMLSchema"
                         xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
            <soap:Body>
              <DailyItemUpdateDS xmlns="http://webservices.theshootingwarehouse.com/smart/Inventory.asmx">
                <CustomerNumber>99994</CustomerNumber>
                <UserName>99994</UserName>
                <Password>12345</Password>
                <LastUpdate>${startDate}</LastUpdate>
                <LastItem>-1</LastItem>
                <Source>FPR</Source>
              </DailyItemUpdateDS>
            </soap:Body>
          </soap:Envelope>`;
        
        // Make API request
        const response = await fetch('http://localhost:8888/.netlify/functions/inventory', {
          method: 'POST',
          headers: {
            'Content-Type': 'text/xml'
          },
          body: soapBody
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        const result = await response.json();
        const xml = new window.DOMParser().parseFromString(result.xml, "text/xml");
        
        // Parse XML data
        const items = Array.from(xml.getElementsByTagName("Table"));
        
        // Process data
        allData = items.map(item => {
          const itemNumber = item.getElementsByTagName("ItemNumber")[0]?.textContent || "";
          const description = item.getElementsByTagName("Description")[0]?.textContent || "";
          const price = parseFloat(item.getElementsByTagName("Retail")[0]?.textContent || "0");
          
          // Extract additional data if available
          const category = item.getElementsByTagName("Category")[0]?.textContent || "N/A";
          const stock = parseInt(item.getElementsByTagName("QtyOnHand")[0]?.textContent || "0");
          
          return {
            itemNumber,
            description,
            price,
            category,
            stock
          };
        });
        
        // Apply initial filters
        applyFilters();
        
        // Update active filters display
        updateActiveFilters();
        
      } catch (error) {
        console.error("Error loading data:", error);
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" class="text-center text-danger">
              Error loading data. Please try again or check your connection.
            </td>
          </tr>
        `;
      } finally {
        // Hide loading indicator
        loadingIndicator.classList.add('d-none');
      }
    }
    
    // Apply filters to data
    function applyFilters() {
      const searchTerm = searchInput.value.toLowerCase();
      const maxPrice = parseInt(priceRangeInput.value);
      
      filteredData = allData.filter(item => {
        // Apply search filter
        const matchesSearch = 
          item.itemNumber.toLowerCase().includes(searchTerm) || 
          item.description.toLowerCase().includes(searchTerm);
        
        // Apply price filter
        const matchesPrice = item.price <= maxPrice;
        
        return matchesSearch && matchesPrice;
      });
      
      // Reset to first page when filters change
      currentPage = 1;
      
      // Render table with filtered data
      renderTable();
      
      // Update active filters display
      updateActiveFilters();
    }
    
    // Update active filters display
    function updateActiveFilters() {
      const filters = [];
      
      if (searchInput.value) {
        filters.push(`Search: "${searchInput.value}"`);
      }
      
      if (priceRangeInput.value < 2000) {
        filters.push(`Max Price: $${priceRangeInput.value}`);
      }
      
      if (filters.length > 0) {
        activeFiltersDiv.innerHTML = `
          <div class="mt-2">
            <strong>Active Filters:</strong> 
            ${filters.map(filter => `
              <span class="badge bg-primary filter-badge" onclick="clearFilter('${filter}')">${filter} ✕</span>
            `).join('')}
            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="clearAllFilters()">Clear All</button>
          </div>
        `;
      } else {
        activeFiltersDiv.innerHTML = '';
      }
    }
    
    // Clear specific filter
    function clearFilter(filterText) {
      if (filterText.startsWith('Search:')) {
        searchInput.value = '';
      } else if (filterText.startsWith('Max Price:')) {
        priceRangeInput.value = 2000;
        priceValueSpan.textContent = '2000';
      }
      
      applyFilters();
    }
    
    // Clear all filters
    function clearAllFilters() {
      searchInput.value = '';
      priceRangeInput.value = 2000;
      priceValueSpan.textContent = '2000';
      
      applyFilters();
    }
    
    // Render table with current page data
    function renderTable() {
      if (filteredData.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" class="text-center">No matching data found.</td>
          </tr>
        `;
        updatePaginationInfo(0, 0, 0);
        renderPagination(0);
        return;
      }
      
      // Calculate pagination
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, filteredData.length);
      const pageData = filteredData.slice(startIndex, endIndex);
      
      // Render table rows
      tableBody.innerHTML = pageData.map(item => `
        <tr>
          <td>${item.itemNumber}</td>
          <td>${item.description}</td>
          <td>$${item.price.toFixed(2)}</td>
          <td>${item.category}</td>
          <td>${item.stock}</td>
        </tr>
      `).join('');
      
      // Update pagination info
      updatePaginationInfo(startIndex + 1, endIndex, filteredData.length);
      
      // Render pagination controls
      renderPagination(Math.ceil(filteredData.length / itemsPerPage));
    }
    
    // Update pagination info text
    function updatePaginationInfo(start, end, total) {
      startItemSpan.textContent = start;
      endItemSpan.textContent = end;
      totalItemsSpan.textContent = total;
    }
    
    // Render pagination controls
    function renderPagination(totalPages) {
      if (totalPages <= 1) {
        paginationElement.innerHTML = '';
        return;
      }
      
      let paginationHTML = `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="changePage(1); return false;">First</a>
        </li>
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">&laquo;</a>
        </li>
      `;
      
      // Calculate visible page range
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      
      // Adjust if we're near the end
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      // Generate page numbers
      for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
          <li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
          </li>
        `;
      }
      
      paginationHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">&raquo;</a>
        </li>
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="changePage(${totalPages}); return false;">Last</a>
        </li>
      `;
      
      paginationElement.innerHTML = paginationHTML;
    }
    
    // Change current page
    function changePage(page) {
      currentPage = page;
      renderTable();
      // Scroll to top of table
      document.getElementById('dataTable').scrollIntoView({ behavior: 'smooth' });
    }
    
    // Initialize price value display
    updatePriceValue();
  </script>
</body>
</html>